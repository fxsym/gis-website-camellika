<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="./resources/ol.css">
    <link rel="stylesheet" href="resources/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="resources/horsey.min.css">
    <link rel="stylesheet" type="text/css" href="resources/ol-search-layer.min.css">
    <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
    <link rel="stylesheet" href="./resources/qgis2web.css">
    <link rel="stylesheet" href="./styles/style.css">

    <title>Peta Desa</title>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">üó∫Ô∏è GIS Karanggayam</div>
            <ul class="nav-menu">
                <li><a href="../index.html" class="nav-link">Beranda</a></li>
                <li><a href="petadesa.html" class="nav-link active">Peta Desa</a></li>
                <li><a href="../petakecamatan/petakecamatan.html" class="nav-link">Peta Kecamatan</a></li>
                <li><a href="../tentang.html" class="nav-link">Tentang</a></li>

                <!-- Hamburger Menu - Always Visible -->
                <li>
                    <button class="hamburger-menu" id="hamburgerMenu" aria-label="Toggle Layer Panel">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">Memuat Peta Desa...</div>
    </div>

    <!-- Map -->
    <div id="map">
        <div id="popup" class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer">‚úï</a>
            <div id="popup-content"></div>
        </div>
    </div>

    <!-- Layer Control Panel -->
    <div class="layer-panel collapsed" id="layerPanel">
        <!-- Close Button -->
        <button class="panel-close" id="panelClose" aria-label="Close Panel">‚úï</button>

        <div class="panel-header">
            üìç Kontrol Layer
        </div>

        <!-- Search Box -->
        <div class="search-container">
            <input type="text" class="search-box" id="layerSearch" placeholder="Cari layer...">
            <span class="search-icon">üîç</span>
            <div class="search-results" id="searchResults"></div>
        </div>

        <!-- Toggle All Layer -->
        <div class="toggle-all-item">
            <span class="toggle-all-name">‚ö°Semua Layer</span>
            <div class="toggle-switch" id="toggleAllSwitch" onclick="toggleAllLayersSwitch(this)">
                <div class="toggle-slider"></div>
            </div>
        </div>

        <!-- Layer Groups -->
        <div id="layerGroups">
            <!-- Base Map -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('basemap')">
                    <span class="layer-group-title">
                        üó∫Ô∏è Peta Dasar
                    </span>
                    <span class="layer-group-toggle" id="toggle-basemap">‚ñº</span>
                </div>
                <div class="layer-list" id="group-basemap">
                    <div class="layer-item">
                        <span class="layer-name">Satelit</span>
                        <div class="toggle-switch" onclick="toggleLayer(0, this)" data-layer="0">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">OpenStreetMap</span>
                        <div class="toggle-switch" onclick="toggleLayer(1, this)" data-layer="1">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Batas Administratif -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('admin')">
                    <span class="layer-group-title">
                        üèõÔ∏è Batas Administratif
                    </span>
                    <span class="layer-group-toggle" id="toggle-admin">‚ñº</span>
                </div>
                <div class="layer-list" id="group-admin">
                    <div class="layer-item">
                        <span class="layer-name">Batas Desa</span>
                        <div class="toggle-switch" onclick="toggleLayer(2, this)" data-layer="2">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RW (Rukun Warga) -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('rw')">
                    <span class="layer-group-title">
                        üèòÔ∏è Rukun Warga (RW)
                    </span>
                    <span class="layer-group-toggle" id="toggle-rw">‚ñº</span>
                </div>
                <div class="layer-list" id="group-rw">
                    <div class="layer-item">
                        <span class="layer-name">RW 6</span>
                        <div class="toggle-switch" onclick="toggleLayer(3, this)" data-layer="3">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RW 5</span>
                        <div class="toggle-switch" onclick="toggleLayer(4, this)" data-layer="4">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RW 4</span>
                        <div class="toggle-switch" onclick="toggleLayer(5, this)" data-layer="5">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RW 3</span>
                        <div class="toggle-switch" onclick="toggleLayer(6, this)" data-layer="6">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RW 2</span>
                        <div class="toggle-switch" onclick="toggleLayer(7, this)" data-layer="7">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RW 1</span>
                        <div class="toggle-switch" onclick="toggleLayer(8, this)" data-layer="8">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RT RW6 -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('rt-rw6')">
                    <span class="layer-group-title">
                        üè† RT - RW 6
                    </span>
                    <span class="layer-group-toggle" id="toggle-rt-rw6">‚ñº</span>
                </div>
                <div class="layer-list" id="group-rt-rw6">
                    <div class="layer-item">
                        <span class="layer-name">RT 6 RW 6</span>
                        <div class="toggle-switch" onclick="toggleLayer(9, this)" data-layer="9">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 5 RW 6</span>
                        <div class="toggle-switch" onclick="toggleLayer(10, this)" data-layer="10">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 4 RW 6</span>
                        <div class="toggle-switch" onclick="toggleLayer(11, this)" data-layer="11">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 3 RW 6</span>
                        <div class="toggle-switch" onclick="toggleLayer(12, this)" data-layer="12">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 2 RW 6</span>
                        <div class="toggle-switch" onclick="toggleLayer(13, this)" data-layer="13">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 1 RW 6</span>
                        <div class="toggle-switch" onclick="toggleLayer(14, this)" data-layer="14">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RT RW4 -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('rt-rw4')">
                    <span class="layer-group-title">
                        üè† RT - RW 4
                    </span>
                    <span class="layer-group-toggle" id="toggle-rt-rw4">‚ñº</span>
                </div>
                <div class="layer-list" id="group-rt-rw4">
                    <div class="layer-item">
                        <span class="layer-name">RT 5 RW 4</span>
                        <div class="toggle-switch" onclick="toggleLayer(15, this)" data-layer="15">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 4 RW 4</span>
                        <div class="toggle-switch" onclick="toggleLayer(16, this)" data-layer="16">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 3 RW 4</span>
                        <div class="toggle-switch" onclick="toggleLayer(17, this)" data-layer="17">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 2 RW 4</span>
                        <div class="toggle-switch" onclick="toggleLayer(18, this)" data-layer="18">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 1 RW 4</span>
                        <div class="toggle-switch" onclick="toggleLayer(19, this)" data-layer="19">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RT RW3 -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('rt-rw3')">
                    <span class="layer-group-title">
                        üè† RT - RW 3
                    </span>
                    <span class="layer-group-toggle" id="toggle-rt-rw3">‚ñº</span>
                </div>
                <div class="layer-list" id="group-rt-rw3">
                    <div class="layer-item">
                        <span class="layer-name">RT 3 RW 3</span>
                        <div class="toggle-switch" onclick="toggleLayer(20, this)" data-layer="20">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 2 RW 3</span>
                        <div class="toggle-switch" onclick="toggleLayer(21, this)" data-layer="21">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 1 RW 3</span>
                        <div class="toggle-switch" onclick="toggleLayer(22, this)" data-layer="22">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RT RW5 -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('rt-rw5')">
                    <span class="layer-group-title">
                        üè† RT - RW 5
                    </span>
                    <span class="layer-group-toggle" id="toggle-rt-rw5">‚ñº</span>
                </div>
                <div class="layer-list" id="group-rt-rw5">
                    <div class="layer-item">
                        <span class="layer-name">RT 4 RW 5</span>
                        <div class="toggle-switch" onclick="toggleLayer(23, this)" data-layer="23">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 3 RW 5</span>
                        <div class="toggle-switch" onclick="toggleLayer(24, this)" data-layer="24">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 2 RW 5</span>
                        <div class="toggle-switch" onclick="toggleLayer(25, this)" data-layer="25">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 1 RW 5</span>
                        <div class="toggle-switch" onclick="toggleLayer(26, this)" data-layer="26">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RT RW2 -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('rt-rw2')">
                    <span class="layer-group-title">
                        üè† RT - RW 2
                    </span>
                    <span class="layer-group-toggle" id="toggle-rt-rw2">‚ñº</span>
                </div>
                <div class="layer-list" id="group-rt-rw2">
                    <div class="layer-item">
                        <span class="layer-name">RT 3 RW 2</span>
                        <div class="toggle-switch" onclick="toggleLayer(27, this)" data-layer="27">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 2 RW 2</span>
                        <div class="toggle-switch" onclick="toggleLayer(28, this)" data-layer="28">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 1 RW 2</span>
                        <div class="toggle-switch" onclick="toggleLayer(29, this)" data-layer="29">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RT RW1 -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('rt-rw1')">
                    <span class="layer-group-title">
                        üè† RT - RW 1
                    </span>
                    <span class="layer-group-toggle" id="toggle-rt-rw1">‚ñº</span>
                </div>
                <div class="layer-list" id="group-rt-rw1">
                    <div class="layer-item">
                        <span class="layer-name">RT 6 RW 1</span>
                        <div class="toggle-switch" onclick="toggleLayer(30, this)" data-layer="30">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 5 RW 1</span>
                        <div class="toggle-switch" onclick="toggleLayer(31, this)" data-layer="31">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 4 RW 1</span>
                        <div class="toggle-switch" onclick="toggleLayer(32, this)" data-layer="32">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 3 RW 1</span>
                        <div class="toggle-switch" onclick="toggleLayer(33, this)" data-layer="33">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 2 RW 1</span>
                        <div class="toggle-switch" onclick="toggleLayer(34, this)" data-layer="34">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">RT 1 RW 1</span>
                        <div class="toggle-switch" onclick="toggleLayer(35, this)" data-layer="35">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Penggunaan Lahan -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('landuse')">
                    <span class="layer-group-title">
                        üåæ Penggunaan Lahan
                    </span>
                    <span class="layer-group-toggle" id="toggle-landuse">‚ñº</span>
                </div>
                <div class="layer-list" id="group-landuse">
                    <div class="layer-item">
                        <span class="layer-name">Hutan Kebun Warga</span>
                        <div class="toggle-switch" onclick="toggleLayer(36, this)" data-layer="36">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Perkebunan</span>
                        <div class="toggle-switch" onclick="toggleLayer(38, this)" data-layer="38">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Perhutani</span>
                        <div class="toggle-switch" onclick="toggleLayer(39, this)" data-layer="39">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Sawah</span>
                        <div class="toggle-switch" onclick="toggleLayer(40, this)" data-layer="40">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Sawah Saya</span>
                        <div class="toggle-switch" onclick="toggleLayer(48, this)" data-layer="48">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bangunan & Fasilitas -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('buildings')">
                    <span class="layer-group-title">
                        üè¢ Bangunan & Fasilitas
                    </span>
                    <span class="layer-group-toggle" id="toggle-buildings">‚ñº</span>
                </div>
                <div class="layer-list" id="group-buildings">
                    <div class="layer-item">
                        <span class="layer-name">Bangunan</span>
                        <div class="toggle-switch" onclick="toggleLayer(37, this)" data-layer="37">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Tempat Ibadah</span>
                        <div class="toggle-switch" onclick="toggleLayer(41, this)" data-layer="41">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Fasilitas Pendidikan</span>
                        <div class="toggle-switch" onclick="toggleLayer(42, this)" data-layer="42">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Rumah Saya</span>
                        <div class="toggle-switch" onclick="toggleLayer(43, this)" data-layer="43">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Balai Desa</span>
                        <div class="toggle-switch" onclick="toggleLayer(49, this)" data-layer="49">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">SPBU</span>
                        <div class="toggle-switch" onclick="toggleLayer(50, this)" data-layer="50">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Rumah Tokoh Masyarakat</span>
                        <div class="toggle-switch" onclick="toggleLayer(51, this)" data-layer="51">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Fasilitas Kesehatan</span>
                        <div class="toggle-switch" onclick="toggleLayer(52, this)" data-layer="52">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Kuburan Desa</span>
                        <div class="toggle-switch" onclick="toggleLayer(53, this)" data-layer="53">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fasilitas Umum -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('public')">
                    <span class="layer-group-title">
                        ‚öΩ Fasilitas Umum
                    </span>
                    <span class="layer-group-toggle" id="toggle-public">‚ñº</span>
                </div>
                <div class="layer-list" id="group-public">
                    <div class="layer-item">
                        <span class="layer-name">Clipped</span>
                        <div class="toggle-switch" onclick="toggleLayer(44, this)" data-layer="44">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Lapangan</span>
                        <div class="toggle-switch" onclick="toggleLayer(45, this)" data-layer="45">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Komersial -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('commercial')">
                    <span class="layer-group-title">
                        üè™ Komersial
                    </span>
                    <span class="layer-group-toggle" id="toggle-commercial">‚ñº</span>
                </div>
                <div class="layer-list" id="group-commercial">
                    <div class="layer-item">
                        <span class="layer-name">Toko</span>
                        <div class="toggle-switch" onclick="toggleLayer(46, this)" data-layer="46">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Bengkel</span>
                        <div class="toggle-switch" onclick="toggleLayer(47, this)" data-layer="47">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Infrastruktur -->
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleGroup('infrastructure')">
                    <span class="layer-group-title">
                        üõ£Ô∏è Infrastruktur
                    </span>
                    <span class="layer-group-toggle" id="toggle-infrastructure">‚ñº</span>
                </div>
                <div class="layer-list" id="group-infrastructure">
                    <div class="layer-item">
                        <span class="layer-name">Jalan Kecamatan</span>
                        <div class="toggle-switch" onclick="toggleLayer(54, this)" data-layer="54">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Jalan Desa</span>
                        <div class="toggle-switch" onclick="toggleLayer(55, this)" data-layer="55">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="layer-item">
                        <span class="layer-name">Sungai</span>
                        <div class="toggle-switch" onclick="toggleLayer(56, this)" data-layer="56">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="resources/qgis2web_expressions.js"></script>
    <script src="./resources/functions.js"></script>
    <script src="./resources/ol.js"></script>
    <script src="resources/horsey.min.js"></script>
    <script src="resources/ol-search-layer.js"></script>
    <script src="./resources/ol-layerswitcher.js"></script>
    <script src="resources/photon-geocoder-autocomplete.min.js"></script>
    <script src="loader.js"></script>
    <script src="./resources/Autolinker.min.js"></script>

    <script>
        // Global variable to store map layers
        let mapLayers = [];
        let mapInitialized = false;
        let featureDatabase = [];
        let highlightLayer;

        // Wait for map to be fully initialized
        function getAllLayers(layerArray) {
            let allLayers = [];
            layerArray.forEach(layer => {
                if (layer.getLayers) {
                    allLayers = allLayers.concat(getAllLayers(layer.getLayers().getArray()));
                } else {
                    allLayers.push(layer);
                }
            });
            return allLayers;
        }

        function initializeMapLayers() {
            if (typeof map !== 'undefined' && map.getLayers) {
                mapLayers = getAllLayers(map.getLayers().getArray());
                if (mapLayers.length > 0) {
                    mapInitialized = true;
                    console.log(`Map initialized with ${mapLayers.length} layers`);

                    // Set all layers to visible by default (except keep base maps as is)
                    for (let i = 2; i < mapLayers.length; i++) {
                        if (mapLayers[i] && mapLayers[i].setVisible) {
                            try {
                                mapLayers[i].setVisible(true);
                            } catch (error) {
                                console.warn(`Cannot set visibility for layer ${i}:`, error);
                            }
                        }
                    }

                    updateToggleStates();
                    return true;
                }
            }
            return false;
        }

        // Fungsi untuk mengindeks semua features dari layers
        function indexAllFeatures() {
            featureDatabase = [];
            mapLayers.forEach((layer, layerIndex) => {
                if (layer.getSource && typeof layer.getSource === 'function') {
                    const source = layer.getSource();
                    if (source && source.getFeatures) {
                        const features = source.getFeatures();
                        features.forEach(feature => {
                            const properties = feature.getProperties();
                            const geometry = feature.getGeometry();
                            const toggleElement = document.querySelector(`[data-layer="${layerIndex}"]`);
                            const layerName = toggleElement ?
                                toggleElement.closest('.layer-item').querySelector('.layer-name').textContent :
                                `Layer ${layerIndex}`;
                            featureDatabase.push({
                                layerIndex: layerIndex,
                                layerName: layerName,
                                feature: feature,
                                geometry: geometry,
                                properties: properties,
                                searchText: createSearchText(properties)
                            });
                        });
                    }
                }
            });
            console.log(`Indexed ${featureDatabase.length} features`);
        }

        // Toggle All Layers Function - Single Switch
        function toggleAllLayersSwitch(toggleElement) {
            if (!mapInitialized) {
                console.warn('Map not yet initialized. Please wait...');
                return;
            }

            // Check current state
            const isCurrentlyActive = toggleElement.classList.contains('active');
            const newState = !isCurrentlyActive;

            // Skip base maps (layer 0 and 1)
            for (let i = 2; i < mapLayers.length; i++) {
                const layer = mapLayers[i];
                if (layer) {
                    try {
                        layer.setVisible(newState);
                    } catch (error) {
                        console.warn(`Cannot toggle layer ${i}:`, error);
                    }
                }
            }

            // Update all toggle switches di layer items
            document.querySelectorAll('.layer-item .toggle-switch').forEach(toggle => {
                const layerIndex = parseInt(toggle.getAttribute('data-layer'));
                // Skip base maps
                if (layerIndex >= 2) {
                    if (newState) {
                        toggle.classList.add('active');
                    } else {
                        toggle.classList.remove('active');
                    }
                }
            });

            // Update toggle all switch visual
            if (newState) {
                toggleElement.classList.add('active');
            } else {
                toggleElement.classList.remove('active');
            }

            console.log(`All layers ${newState ? 'enabled' : 'disabled'}`);
        }

        // Fungsi untuk membuat teks pencarian dari properties
        function createSearchText(properties) {
            let searchTerms = [];
            const searchFields = ['Nama', 'nama', 'name', 'NAME', 'Jenjang', 'Alamat', 'alamat', 'Jenis', 'jenis', 'Keterangan', 'keterangan'];
            searchFields.forEach(field => {
                if (properties[field]) {
                    searchTerms.push(properties[field].toString().toLowerCase());
                }
            });
            return searchTerms.join(' ');
        }

        // Fungsi untuk mencari features
        function searchFeatures(searchTerm) {
            if (!searchTerm || searchTerm.length < 2) return [];
            const term = searchTerm.toLowerCase();
            const results = [];
            featureDatabase.forEach(item => {
                if (item.searchText.includes(term)) {
                    results.push(item);
                }
            });
            return results.slice(0, 10);
        }

        // Fungsi untuk zoom ke feature
        function zoomToFeature(featureData) {
            const geometry = featureData.geometry;
            if (!geometry || !map) return;

            const layer = mapLayers[featureData.layerIndex];
            if (layer) {
                layer.setVisible(true);
                const toggleElement = document.querySelector(`[data-layer="${featureData.layerIndex}"]`);
                if (toggleElement) {
                    toggleElement.classList.add('active');
                }
            }

            const view = map.getView();
            const extent = geometry.getExtent();
            view.fit(extent, {
                duration: 1000,
                padding: [100, 100, 100, 100],
                maxZoom: 18
            });

            highlightFeature(featureData.feature);
        }

        // Fungsi untuk highlight feature
        function highlightFeature(feature) {
            if (highlightLayer) {
                map.removeLayer(highlightLayer);
            }

            const highlightStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#f5576c',
                    width: 3
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(245, 87, 108, 0.2)'
                }),
                image: new ol.style.Circle({
                    radius: 10,
                    fill: new ol.style.Fill({
                        color: '#f5576c'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#ffffff',
                        width: 2
                    })
                })
            });

            const highlightFeature = feature.clone();
            highlightLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [highlightFeature]
                }),
                style: highlightStyle,
                zIndex: 1000
            });

            map.addLayer(highlightLayer);

            setTimeout(() => {
                if (highlightLayer) {
                    map.removeLayer(highlightLayer);
                    highlightLayer = null;
                }
            }, 3000);
        }

        // Fungsi helper untuk search layer names
        function searchLayerNames(searchTerm) {
            const allLayers = document.querySelectorAll('.layer-item');
            const matches = [];
            allLayers.forEach(item => {
                const layerName = item.querySelector('.layer-name').textContent.toLowerCase();
                const layerGroup = item.closest('.layer-group').querySelector('.layer-group-title').textContent;
                const layerIndex = item.querySelector('.toggle-switch').getAttribute('data-layer');
                if (layerName.includes(searchTerm)) {
                    matches.push({
                        type: 'layer',
                        name: item.querySelector('.layer-name').textContent,
                        group: layerGroup,
                        layerIndex: layerIndex,
                        element: item
                    });
                }
            });
            return matches;
        }

        // Fungsi untuk mendapatkan nama tampilan feature
        function getFeatureDisplayName(featureData) {
            const props = featureData.properties;
            const nameFields = ['Nama', 'nama', 'name', 'NAME', 'Jenis', 'jenis'];
            for (let field of nameFields) {
                if (props[field]) {
                    return props[field];
                }
            }
            const otherFields = ['Jenjang', 'Alamat', 'Keterangan'];
            for (let field of otherFields) {
                if (props[field]) {
                    return props[field];
                }
            }
            return 'Feature tanpa nama';
        }

        // Fungsi global untuk zoom dari hasil pencarian
        window.zoomToFeatureFromSearch = function (layerIndex, featureIndex) {
            const featureData = featureDatabase[featureIndex];
            if (featureData) {
                zoomToFeature(featureData);
                if (window.innerWidth <= 768) {
                    document.getElementById('layerPanel').classList.add('collapsed');
                    document.getElementById('hamburgerMenu').classList.remove('active');
                }
                const searchInput = document.getElementById('layerSearch');
                const searchResults = document.getElementById('searchResults');
                searchInput.value = '';
                searchResults.classList.remove('active');
                searchResults.innerHTML = '';
            }
        };

        // Check map initialization periodically
        window.addEventListener('load', function () {
            let attempts = 0;
            const maxAttempts = 20;
            const checkInterval = setInterval(function () {
                attempts++;
                if (initializeMapLayers()) {
                    clearInterval(checkInterval);
                    document.getElementById('loading-screen').classList.add('hidden');
                    console.log('Map ready!');
                    setTimeout(() => {
                        indexAllFeatures();
                    }, 2000);
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    document.getElementById('loading-screen').classList.add('hidden');
                    console.warn('Map initialization timeout');
                }
            }, 500);
        });

        // Toggle layer visibility
        function toggleLayer(layerIndex, toggleElement) {
            if (!mapInitialized) {
                console.warn('Map not yet initialized. Please wait...');
                return;
            }
            if (layerIndex < 0 || layerIndex >= mapLayers.length) {
                console.error(`Layer index ${layerIndex} out of bounds (0-${mapLayers.length - 1})`);
                return;
            }
            const layer = mapLayers[layerIndex];
            if (!layer) {
                console.warn(`Layer at index ${layerIndex} is undefined`);
                return;
            }
            try {
                const isVisible = layer.getVisible();
                layer.setVisible(!isVisible);
                toggleElement.classList.toggle('active');
            } catch (error) {
                console.error(`Error toggling layer ${layerIndex}:`, error);
            }
        }

        // Update toggle states based on current layer visibility
        function updateToggleStates() {
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                const layerIndex = parseInt(toggle.getAttribute('data-layer'));
                if (layerIndex >= 0 && layerIndex < mapLayers.length && mapLayers[layerIndex]) {
                    try {
                        const isVisible = mapLayers[layerIndex].getVisible();
                        if (isVisible) {
                            toggle.classList.add('active');
                        } else {
                            toggle.classList.remove('active');
                        }
                    } catch (error) {
                        console.warn(`Cannot get visibility for layer ${layerIndex}`);
                    }
                }
            });

            // Update toggle all switch based on layer states
            updateToggleAllState();
        }

        // Function to update toggle all switch state
        function updateToggleAllState() {
            const toggleAllSwitch = document.getElementById('toggleAllSwitch');
            if (!toggleAllSwitch) return;

            // Check if any layer (except base maps) is visible
            let anyLayerVisible = false;
            for (let i = 2; i < mapLayers.length; i++) {
                if (mapLayers[i] && mapLayers[i].getVisible && mapLayers[i].getVisible()) {
                    anyLayerVisible = true;
                    break;
                }
            }

            // Update toggle all switch
            if (anyLayerVisible) {
                toggleAllSwitch.classList.add('active');
            } else {
                toggleAllSwitch.classList.remove('active');
            }
        }

        // Toggle group collapse/expand
        function toggleGroup(groupId) {
            const groupList = document.getElementById('group-' + groupId);
            const toggleIcon = document.getElementById('toggle-' + groupId);
            groupList.classList.toggle('collapsed');
            toggleIcon.classList.toggle('collapsed');
        }

        // Hamburger Menu Toggle
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const layerPanel = document.getElementById('layerPanel');
        const panelClose = document.getElementById('panelClose');

        hamburgerMenu.addEventListener('click', function (e) {
            e.stopPropagation();
            this.classList.toggle('active');
            layerPanel.classList.toggle('collapsed');
        });

        panelClose.addEventListener('click', function (e) {
            e.stopPropagation();
            layerPanel.classList.add('collapsed');
            hamburgerMenu.classList.remove('active');
        });

        document.addEventListener('click', function (e) {
            if (!layerPanel.contains(e.target) &&
                !hamburgerMenu.contains(e.target) &&
                !layerPanel.classList.contains('collapsed')) {
                layerPanel.classList.add('collapsed');
                hamburgerMenu.classList.remove('active');
            }
        });

        layerPanel.addEventListener('click', function (e) {
            e.stopPropagation();
        });

        // Search functionality
        const searchInput = document.getElementById('layerSearch');
        const searchResults = document.getElementById('searchResults');

        searchInput.addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase().trim();

            if (searchTerm.length === 0) {
                searchResults.classList.remove('active');
                searchResults.innerHTML = '';
                return;
            }

            const layerMatches = searchLayerNames(searchTerm);
            const featureMatches = searchFeatures(searchTerm);
            const allMatches = [...layerMatches, ...featureMatches];

            if (allMatches.length > 0) {
                searchResults.innerHTML = allMatches.map(match => {
                    if (match.type === 'layer') {
                        return `
                    <div class="search-result-item" onclick="scrollToLayer(this)" data-layer="${match.layerIndex}">
                        <div class="search-result-icon">üìÅ</div>
                        <div class="search-result-info">
                            <div class="search-result-name">${match.name}</div>
                            <div class="search-result-layer">${match.group}</div>
                        </div>
                    </div>
                `;
                    } else {
                        return `
                    <div class="search-result-item" onclick="zoomToFeatureFromSearch(${match.layerIndex}, ${featureDatabase.indexOf(match)})" data-feature="${featureDatabase.indexOf(match)}">
                        <div class="search-result-icon">üìç</div>
                        <div class="search-result-info">
                            <div class="search-result-name">${getFeatureDisplayName(match)}</div>
                            <div class="search-result-layer">${match.layerName}</div>
                        </div>
                    </div>
                `;
                    }
                }).join('');
                searchResults.classList.add('active');
            } else {
                searchResults.innerHTML = '<div class="search-result-item" style="pointer-events: none;">Tidak ada hasil</div>';
                searchResults.classList.add('active');
            }
        });

        // Scroll to layer from search results
        function scrollToLayer(element) {
            const layerIndex = element.getAttribute('data-layer');
            const targetToggle = document.querySelector(`.toggle-switch[data-layer="${layerIndex}"]`);

            if (targetToggle) {
                const parentGroup = targetToggle.closest('.layer-list');
                if (parentGroup && parentGroup.classList.contains('collapsed')) {
                    const groupId = parentGroup.id.replace('group-', '');
                    toggleGroup(groupId);
                }

                targetToggle.closest('.layer-item').scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                const layerItem = targetToggle.closest('.layer-item');
                layerItem.style.background = 'linear-gradient(135deg, rgba(240, 147, 251, 0.3) 0%, rgba(245, 87, 108, 0.3) 100%)';
                setTimeout(() => {
                    layerItem.style.background = '';
                }, 1000);
            }

            searchInput.value = '';
            searchResults.classList.remove('active');
            searchResults.innerHTML = '';
        }

        // Add hover effects to layer items
        document.querySelectorAll('.layer-item').forEach(item => {
            item.addEventListener('mouseenter', function () {
                this.style.transform = 'translateX(3px)';
            });
            item.addEventListener('mouseleave', function () {
                this.style.transform = '';
            });
        });

        // Close search results when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.remove('active');
                searchResults.innerHTML = '';
            }
        });

        console.log('Enhanced Layer Search with Zoom loaded!');
    </script>
</body>

</html>